name: Manual Production Data Seeding

on:
  workflow_dispatch:
    inputs:
      email:
        description: 'Email for seeding user'
        required: true
        default: 'demo@example.com'
        type: string
      clean_data:
        description: 'Clean existing data before seeding'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  manual-seed:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Set environment variables
      run: |
        if [ "${{ github.event.inputs.environment }}" == "production" ]; then
          echo "CONTAINER_NAME=django-be-main_web_1" >> $GITHUB_ENV
          echo "SEEDING_MODE=production" >> $GITHUB_ENV
        else
          echo "CONTAINER_NAME=django-be-staging_web_1" >> $GITHUB_ENV
          echo "SEEDING_MODE=server" >> $GITHUB_ENV
        fi

    - name: Run Manual Data Seeding
      run: |
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} << 'EOF'
          echo "ðŸŽ¯ Manual Seeding for ${{ github.event.inputs.environment }}"
          echo "ðŸ“§ Email: ${{ github.event.inputs.email }}"
          echo "ðŸ§¹ Clean data: ${{ github.event.inputs.clean_data }}"
          echo "ðŸ—ï¸ Mode: ${{ env.SEEDING_MODE }}"
          echo "ðŸ“¦ Container: ${{ env.CONTAINER_NAME }}"
          echo ""
          
          # Check if container is running
          if ! docker ps --format "table {{.Names}}" | grep -q "${{ env.CONTAINER_NAME }}"; then
            echo "âŒ Container ${{ env.CONTAINER_NAME }} is not running"
            echo "ðŸ“‹ Available containers:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            exit 1
          fi
          
          echo "âœ… Container ${{ env.CONTAINER_NAME }} is running"
          
          # Test container access
          if ! docker exec ${{ env.CONTAINER_NAME }} echo "Container accessible"; then
            echo "âŒ Cannot access container ${{ env.CONTAINER_NAME }}"
            exit 1
          fi
          
          # Check if seed_database command exists
          if ! docker exec ${{ env.CONTAINER_NAME }} python manage.py help | grep -q seed_database; then
            echo "âŒ seed_database command not found"
            echo "ðŸ“‹ Available commands:"
            docker exec ${{ env.CONTAINER_NAME }} python manage.py help | grep -E "(seed|database)"
            exit 1
          fi
          
          echo "âœ… seed_database command found"
          
          # Show current data before seeding
          echo "ðŸ“Š Current data before seeding:"
          docker exec ${{ env.CONTAINER_NAME }} python manage.py shell -c "
            from authentication.models import User, Toko
            from produk.models import Produk
            from transaksi.models import Transaksi
            print(f'Users: {User.objects.count()}')
            print(f'Tokos: {Toko.objects.count()}')
            print(f'Products: {Produk.objects.count()}')
            print(f'Transactions: {Transaksi.objects.count()}')
            "
                    
                    # Clean up potential duplicate Satuan entries
                    echo "ðŸ§¹ Cleaning potential duplicate Satuan entries..."
                    docker exec ${{ env.CONTAINER_NAME }} python manage.py shell -c "
            from produk.models import Satuan
            from django.db.models import Count

            duplicates = Satuan.objects.values('nama').annotate(count=Count('nama')).filter(count__gt=1)
            cleaned = 0
            for dup in duplicates:
                nama = dup['nama']
                entries = Satuan.objects.filter(nama=nama).order_by('id')
                keep_first = entries.first()
                delete_others = entries.exclude(id=keep_first.id)
                cleaned += delete_others.count()
                delete_others.delete()

            if cleaned > 0:
                print(f'Cleaned {cleaned} duplicate Satuan entries')
            else:
                print('No duplicate Satuan entries found')
            "
          
          # Build seeding command
          SEED_CMD="python manage.py seed_database --mode=${{ env.SEEDING_MODE }} --email=${{ github.event.inputs.email }}"
          
          # Add clean flag if requested
          if [ "${{ github.event.inputs.clean_data }}" == "true" ]; then
            SEED_CMD="$SEED_CMD --clean"
          fi
          
          echo "ðŸš€ Executing: $SEED_CMD"
          echo ""
          
          # Execute seeding command
          if docker exec ${{ env.CONTAINER_NAME }} $SEED_CMD; then
            echo ""
            echo "âœ… Manual seeding completed successfully!"
            
            # Show data after seeding
            echo "ðŸ“Š Data after seeding:"
            docker exec ${{ env.CONTAINER_NAME }} python manage.py shell -c "
                from authentication.models import User, Toko
                from produk.models import Produk
                from transaksi.models import Transaksi
                print(f'Users: {User.objects.count()}')
                print(f'Tokos: {Toko.objects.count()}')
                print(f'Products: {Produk.objects.count()}')
                print(f'Transactions: {Transaksi.objects.count()}')
                "
            
            # Check for rollback files
            echo "ðŸ“ Checking rollback files:"
            docker exec ${{ env.CONTAINER_NAME }} ls -la /app/seed_logs/rollback_*.log 2>/dev/null | tail -3 || echo "No rollback files found"
            
            # Generate seed ID for reference
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            echo "ðŸ’¾ Seed ID for rollback reference: seed_$TIMESTAMP"
            echo "ðŸ“ Note: Use the actual seed ID from the seeding output above for rollback"
            
          else
            echo "âŒ Seeding command failed"
            echo "ðŸ“‹ Container logs (last 50 lines):"
            docker logs ${{ env.CONTAINER_NAME }} --tail=50
            exit 1
          fi
        EOF

    - name: Generate Summary
      run: |
        echo "## ðŸŽ¯ Manual Seeding Completed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Email:** ${{ github.event.inputs.email }}" >> $GITHUB_STEP_SUMMARY
        echo "**Clean Data:** ${{ github.event.inputs.clean_data }}" >> $GITHUB_STEP_SUMMARY
        echo "**Mode:** ${{ env.SEEDING_MODE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Container:** ${{ env.CONTAINER_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ How to Rollback" >> $GITHUB_STEP_SUMMARY
        echo "1. **GitHub Actions**: Go to Actions > Manual Data Rollback" >> $GITHUB_STEP_SUMMARY
        echo "2. **Manual SSH**: \`docker exec ${{ env.CONTAINER_NAME }} python manage.py seed_database --mode=production --rollback-id=<SEED_ID>\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Use the seed ID from the seeding output above" >> $GITHUB_STEP_SUMMARY